<!doctype html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8">
    <title>Requisições - Admin | LabMaker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/labmaker.css">
</head>

<body>

    <header class="topbar">
        <div class="brand-row">
            <div class="logo-square">IF</div>
            <div>
                <h1>Requisições</h1>
                <p class="muted">Gerenciamento geral – Administrador</p>
            </div>
        </div>

        <div class="right-actions">
            <a href="home" class="btn-ghost">Home</a>
            <button id="logoutBtn" class="btn-ghost red">Sair</button>
        </div>
    </header>

    <main class="container">

        <section class="card">
            <h2>Lista de Requisições</h2>
            <p class="muted">Todas as solicitações feitas pelos usuários</p>

            <div id="lista-accordions">
                <tr>
                    <th>ID</th>
                    <th>Usuário</th>
                    <th>Descrição</th>
                    <th>Status</th>
                    <th>Prioridade</th>
                    <th>Ações</th>
                </tr>
            </div>
        </section>

    </main>

    <script src="js/utils.js"></script>
    <script src="js/api.js"></script>

    <script>

        const user = utils.getCurrentUser();
        if (!user) location.href = "login";
        if (user.tipo !== "ADMIN") {
            alert("Acesso negado.");
            location.href = "home";
        }

        document.getElementById("logoutBtn").addEventListener("click", () => {
            utils.logout();
            location.href = "login";
        });

        async function carregar() {
            try {
                const lista = await api.listarRequisicoes();
                const container = document.getElementById("lista-accordions");

                container.innerHTML = "";

                lista.forEach(r => {

                    const item = document.createElement("div");
                    item.className = "accordion-item";

                    item.innerHTML = `
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <div>
                        <strong>#${r.id}</strong> — ${r.usuario.nome} 
                    </div>
                    <div>
                        <span>${r.status}</span>
                    </div>
                </div>

                <div class="accordion-body">

                    <label><strong>Descrição:</strong></label>
                    <textarea id="descricao-${r.id}" rows="3">${r.descricao}</textarea>

                    <label><strong>URL:</strong></label>
                    <input type="text" id="url-${r.id}" value="${r.url ?? ''}">

                    <label><strong>Material:</strong></label>
                    <input type="text" id="material-${r.id}" value="${r.tipoMaterial ?? ''}">

                    <label><strong>Filamento (g):</strong></label>
                    <input type="number" id="filamento-${r.id}" value="${r.qntdFilamento ?? ''}">

                    <label><strong>Tempo Estimado (min):</strong></label>
                    <input type="number" id="tempo-${r.id}" value="${r.tempoEstimado ?? ''}">

                    <label><strong>Prioridade:</strong></label>
                    <select id="prioridade-${r.id}">
                        <option ${r.prioridade === 0 ? 'selected' : ''}>BAIXA</option>
                        <option ${r.prioridade === 1 ? 'selected' : ''}>MEDIA</option>
                        <option ${r.prioridade === 2 ? 'selected' : ''}>ALTA</option>
                    </select>

                    <label><strong>Status:</strong></label>
                        <select id="status-${r.id}">
                            <option value="PENDENTE" ${r.status === 'PENDENTE' ? 'selected' : ''}>Pendente</option>
                            <option value="EM_IMPRESSAO" ${r.status === 'EM_IMPRESSAO' ? 'selected' : ''}>Em impressão</option>
                            <option value="CONCLUIDA" ${r.status === 'CONCLUIDA' ? 'selected' : ''}>Concluída</option>
                            <option value="CANCELADA" ${r.status === 'CANCELADA' ? 'selected' : ''}>Cancelada</option>
                            <option value="AGUARDANDO_APROVACAO" ${r.status === 'AGUARDANDO_APROVACAO' ? 'selected' : ''}>Aguardando aprovação</option>
                        </select>
                    <br><br>

<button class="btn-small blue" onclick="salvar(${r.id}, ${r.usuario.id})">Salvar Alterações</button>
                    <button class="btn-small red" onclick="deletar(${r.id})">Excluir</button>
                </div>
            `;

                    container.appendChild(item);
                });

            } catch (err) {
                console.error(err);
                alert("Erro ao carregar requisições.");
            }
        }


        function toggleAccordion(header) {
            const body = header.nextElementSibling;
            body.style.display = body.style.display === "block" ? "none" : "block";
        }


        async function salvar(id, usuarioId) {

            console.log(id + " " + usuarioId);


            const payload = {
                usuarioId: usuarioId,
                url: document.getElementById(`url-${id}`).value,
                descricao: document.getElementById(`descricao-${id}`).value,
                qntdFilamento: Number(document.getElementById(`filamento-${id}`).value),
                tempoEstimado: Number(document.getElementById(`tempo-${id}`).value),
                tipoMaterial: document.getElementById(`material-${id}`).value,
                status: document.getElementById(`status-${id}`).value,
                prioridade: Number(document.getElementById(`prioridade-${id}`).value),
                posicao: 0
            };


            console.log(document.getElementById(`status-${id}`).value);

            try {
                await fetch(`http://localhost:8080/requisicoes/${id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                alert("Requisição atualizada!");
                carregar();

            } catch (e) {
                alert("Erro ao salvar.");
            }
        }


        carregar();
    </script>



</body>

</html>